---
- name: Deploy Nautobot full stack on VMs
  hosts: dev_vm,prod_vm
  become: true
  gather_facts: true

  vars:
    # Allow overriding env from CLI: -e environment=dev
    # environment: "{{ environment | default(hostvars[inventory_hostname].environment) }}"
    deploy_env: "{{ deploy_env | default(hostvars[inventory_hostname].environment) }}"

  vars_files:
    - "../group_vars/all/nautobot.yml"
    - "../group_vars/{{ deploy_env }}/nautobot.yml"
    - "../group_vars/{{ deploy_env }}/vault.yml"

  pre_tasks:
    - name: Show deployment context
      ansible.builtin.debug:
        msg:
          - "Deploying Nautobot {{ nautobot_version }} to {{ inventory_hostname }}"
          - "Environment: {{ deploy_env }}"
          - "Deployment type: {{ deployment_type | default('vm') }}"

  roles:
    - role: vm_postgres
      tags: [postgres, infra]

    - role: vm_redis
      tags: [redis, infra]

    - role: vm_nautobot_app
      tags: [nautobot, app]

    - role: vm_nautobot_worker
      tags: [nautobot, worker]

    - role: vm_nautobot_scheduler
      tags: [nautobot, scheduler]

  post_tasks:
    - name: Ensure Nautobot services are running
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: started
        enabled: true
      loop: "{{ nautobot_services }}"
      tags: [verify]

    - name: Check Nautobot HTTP API
      ansible.builtin.uri:
        url: "http://{{ ansible_host }}:8000/"
        method: GET
        status_code: 200
      register: api_check
      retries: 10
      delay: 6
      until: api_check.status == 200
      tags: [verify]

    - name: Show deployment result
      ansible.builtin.debug:
        msg: "Nautobot deployment successful on {{ inventory_hostname }}"
      when: api_check.status == 200
