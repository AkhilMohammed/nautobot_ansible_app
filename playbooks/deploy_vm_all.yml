---
- name: Deploy Nautobot full stack on VMs
  hosts: dev-nautobot-01 
  become: true
  # connection: local
  become_method: sudo
  gather_facts: true

  vars:
    # Allow overriding env from CLI: -e environment=dev
    # environment: "{{ environment | default(hostvars[inventory_hostname].environment) }}"
    deploy_env: "{{ deploy_env | default(hostvars[inventory_hostname].environment) }}"

  vars_files:
    - "../group_vars/all/nautobot.yml"
    - "../group_vars/{{ deploy_env }}/nautobot.yml"
    - "../group_vars/{{ deploy_env }}/vault.yml"

  pre_tasks:
    - name: Show deployment context
      ansible.builtin.debug:
        msg:
          - "Deploying Nautobot {{ nautobot_version }} to {{ inventory_hostname }}"
          - "Environment: {{ deploy_env }}"
          - "Deployment type: {{ deployment_type | default('vm') }}"

  roles:
    - role: vm_postgres
      tags: [postgres, infra]

    - role: vm_redis
      tags: [redis, infra]

    - role: vm_nautobot_app
      tags: [nautobot, app]

    - role: vm_nautobot_worker
      tags: [nautobot, worker]

    - role: vm_nautobot_scheduler
      tags: [nautobot, scheduler]

  post_tasks:
    - name: Ensure Nautobot services are running
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: started
        enabled: true
      loop: "{{ nautobot_services }}"
      tags: [verify]

    - name: Wait for nginx HTTPS port
      ansible.builtin.wait_for:
        port: 443
        host: "{{ ansible_host }}"
        timeout: 30
      tags: [verify]

    - name: Test HTTP ‚Üí HTTPS redirect
      ansible.builtin.uri:
        url: "http://{{ ansible_host }}/"
        method: GET
        status_code: 200
        validate_certs: no
      register: http_redirect
      tags: [verify]

    - name: Check Nautobot HTTPS API (ignore SSL + accept login redirect)
      ansible.builtin.uri:
        url: "https://{{ ansible_host }}/"
        method: GET
        status_code: [200, 302]  # Accept login redirect
        validate_certs: no       # Ignore snakeoil cert
        follow_redirects: no
      register: api_check
      retries: 10
      delay: 6
      until: api_check.status in [200, 302]
      tags: [verify]

    - name: Show deployment result
      ansible.builtin.debug:
        msg: 
          - "‚úÖ Nautobot deployment successful on {{ inventory_hostname }}"
          - "‚úÖ HTTP redirect: {{ http_redirect.status }} ({{ http_redirect.msg.status }})"
          - "‚úÖ HTTPS status: {{ api_check.status }} ({{ api_check.msg.status }})"
          - "üåê Access: https://{{ ansible_host }}/ (accept cert warning)"
      when: api_check.status in [200, 302]
