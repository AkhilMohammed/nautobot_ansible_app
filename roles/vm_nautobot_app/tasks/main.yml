# # ---
# # - name: Ensure system packages are installed
# #   ansible.builtin.apt:
# #     name:
# #       - python3
# #       - python3-pip
# #       - python3-venv
# #       - python3-dev
# #       - build-essential
# #       - libpq-dev
# #       - libxml2-dev
# #       - libxslt1-dev
# #       - libffi-dev
# #       - libssl-dev
# #       - git
# #       - redis-tools
# #       - postgresql-client
# #     state: present
# #     update_cache: yes
# #   tags: packages

# # - name: Set default Python version for Nautobot venv
# #   ansible.builtin.set_fact:
# #     python_version: "{{ python_version | default('python3') }}"

# # - name: Ensure Nautobot defaults
# #   ansible.builtin.set_fact:
# #     nautobot_user: "{{ nautobot_user | default('nautobot') }}"
# #     nautobot_group: "{{ nautobot_group | default('nautobot') }}"
# #     nautobot_root: "{{ nautobot_root | default('/opt/nautobot') }}"
# #     nautobot_logs_path: "{{ nautobot_logs_path | default(nautobot_root + '/logs') }}"
# #     nautobot_media_path: "{{ nautobot_media_path | default(nautobot_root + '/media') }}"
# #     nautobot_static_path: "{{ nautobot_static_path | default(nautobot_root + '/static') }}"
# #     nautobot_git_path: "{{ nautobot_git_path | default(nautobot_root + '/git') }}"
# #     nautobot_git_root: "{{ nautobot_git_root | default(nautobot_root + '/.nautobot') }}"
# #     nautobot_venv: "{{ nautobot_venv | default(nautobot_root + '/venv') }}"

# # - name: Ensure Nautobot root directory exists (no ownership yet)
# #   ansible.builtin.file:
# #     path: "{{ nautobot_root }}"
# #     state: directory
# #     mode: "0755"

# # - name: Create nautobot group
# #   ansible.builtin.group:
# #     name: "{{ nautobot_group }}"
# #     state: present

# # - name: Create nautobot user
# #   ansible.builtin.user:
# #     name: "{{ nautobot_user }}"
# #     group: "{{ nautobot_group }}"
# #     shell: /bin/bash
# #     create_home: yes
# #     home: "{{ nautobot_root }}"

# # - name: Create Nautobot subdirectories with nautobot ownership
# #   ansible.builtin.file:
# #     path: "{{ item }}"
# #     state: directory
# #     owner: "{{ nautobot_user }}"
# #     group: "{{ nautobot_group }}"
# #     mode: "0755"
# #   loop:
# #     - "{{ nautobot_logs_path }}"
# #     - "{{ nautobot_media_path }}"
# #     - "{{ nautobot_static_path }}"
# #     - "{{ nautobot_git_path }}"
# #     - "{{ nautobot_git_root }}"

# # - name: Ensure Nautobot log file exists and writable
# #   ansible.builtin.file:
# #     path: "{{ nautobot_logs_path }}/nautobot.log"
# #     state: touch
# #     owner: "{{ nautobot_user }}"
# #     group: "{{ nautobot_group }}"
# #     mode: "0644"

# # - name: Create Python virtual environment
# #   ansible.builtin.command:
# #     cmd: "{{ python_version }} -m venv {{ nautobot_venv }}"
# #     creates: "{{ nautobot_venv }}/bin/python"
# #   become: true

# # - name: Upgrade pip in virtualenv
# #   ansible.builtin.pip:
# #     name: pip
# #     state: latest
# #     virtualenv: "{{ nautobot_venv }}"

# # - name: Install wheel in virtualenv
# #   ansible.builtin.pip:
# #     name: wheel
# #     state: present
# #     virtualenv: "{{ nautobot_venv }}"

# # - name: Install Nautobot core
# #   ansible.builtin.pip:
# #     name: "nautobot[postgres,redis]=={{ nautobot_version }}"
# #     virtualenv: "{{ nautobot_venv }}"
# #     extra_args: "{{ pip_extra_args | default('') }}"
# #   tags: nautobot-core

# # - name: Install gunicorn in virtualenv
# #   ansible.builtin.pip:
# #     name: gunicorn
# #     state: present
# #     virtualenv: "{{ nautobot_venv }}"

# # - name: Install pip packages (dependencies)
# #   ansible.builtin.pip:
# #     name: "{{ item.name }}=={{ item.version }}"
# #     virtualenv: "{{ nautobot_venv }}"
# #     extra_args: "{{ pip_extra_args | default('') }}"
# #   loop: "{{ nautobot_pip_packages | default([]) }}"
# #   tags: pip-packages

# # - name: Install Git-based packages (plugins)
# #   ansible.builtin.pip:
# #     name: "{{ item.name }}"
# #     virtualenv: "{{ nautobot_venv }}"
# #     extra_args: "{{ pip_extra_args | default('') }}"
# #   loop: "{{ nautobot_git_packages | default([]) }}"
# #   notify:
# #     - Restart nautobot-app
# #     - Restart nautobot-worker
# #     - Restart nautobot-scheduler
# #   tags: git-plugins

# # - name: Deploy nautobot_config.py
# #   ansible.builtin.template:
# #     src: nautobot_config.py.j2
# #     dest: "{{ nautobot_config_path }}"
# #     owner: "{{ nautobot_user }}"
# #     group: "{{ nautobot_group }}"
# #     mode: "0640"
# #   notify:
# #     - Restart nautobot-app
# #     - Restart nautobot-worker
# #     - Restart nautobot-scheduler
# #   tags: config

# # - name: Run database migrations
# #   ansible.builtin.command:
# #     cmd: "{{ nautobot_venv }}/bin/nautobot-server migrate"
# #   environment:
# #     NAUTOBOT_CONFIG: "{{ nautobot_config_path }}"
# #   register: migrate_result
# #   changed_when: "'No migrations to apply' not in migrate_result.stdout"
# #   tags: migrate

# # - name: Collect static files
# #   ansible.builtin.command:
# #     cmd: "{{ nautobot_venv }}/bin/nautobot-server collectstatic --no-input"
# #   environment:
# #     NAUTOBOT_CONFIG: "{{ nautobot_config_path }}"
# #   tags: static

# # - name: Deploy nautobot-app systemd service
# #   ansible.builtin.copy:
# #     dest: "{{ systemd_path }}/nautobot-app.service"
# #     mode: "0644"
# #     content: |
# #       [Unit]
# #       Description=Nautobot WSGI Application
# #       After=network-online.target
# #       Wants=network-online.target

# #       [Service]
# #       Type=simple
# #       User={{ nautobot_user }}
# #       Group={{ nautobot_group }}
# #       WorkingDirectory={{ nautobot_root }}
# #       Environment="NAUTOBOT_CONFIG={{ nautobot_config_path }}"
# #       ExecStart={{ nautobot_venv }}/bin/gunicorn --bind 0.0.0.0:8000 --workers 4 --timeout 300 nautobot.core.wsgi:application
# #       Restart=on-failure
# #       RestartSec=30s

# #       [Install]
# #       WantedBy=multi-user.target
# #   notify: Reload systemd

# # - name: Enable and start nautobot-app service
# #   ansible.builtin.systemd:
# #     name: nautobot-app
# #     enabled: yes
# #     state: started
# #     daemon_reload: yes


# ---
# - name: Ensure system packages are installed
#   ansible.builtin.apt:
#     name:
#       - python3.11
#       - python3.11-venv
#       - python3.11-dev
#       - python3.11-distutils
#       - build-essential
#       - libpq-dev
#       - libxml2-dev
#       - libxslt1-dev
#       - libffi-dev
#       - libssl-dev
#       - git
#       - redis-tools
#       - postgresql-client
#     state: present
#     update_cache: yes
#   tags: packages

# - name: Set Python version for Nautobot
#   ansible.builtin.set_fact:
#     python_version: python3.11

# - name: Ensure Nautobot defaults
#   ansible.builtin.set_fact:
#     nautobot_user: "{{ nautobot_user | default('nautobot') }}"
#     nautobot_group: "{{ nautobot_group | default('nautobot') }}"
#     nautobot_root: "{{ nautobot_root | default('/opt/nautobot') }}"
#     nautobot_logs_path: "{{ nautobot_logs_path | default(nautobot_root + '/logs') }}"
#     nautobot_media_path: "{{ nautobot_media_path | default(nautobot_root + '/media') }}"
#     nautobot_static_path: "{{ nautobot_static_path | default(nautobot_root + '/static') }}"
#     nautobot_git_path: "{{ nautobot_git_path | default(nautobot_root + '/git') }}"
#     nautobot_git_root: "{{ nautobot_git_root | default(nautobot_root + '/.nautobot') }}"
#     nautobot_venv: "{{ nautobot_venv | default(nautobot_root + '/venv') }}"

# - name: Ensure Nautobot root directory exists (no ownership yet)
#   ansible.builtin.file:
#     path: "{{ nautobot_root }}"
#     state: directory
#     mode: "0755"

# - name: Create nautobot group
#   ansible.builtin.group:
#     name: "{{ nautobot_group }}"
#     state: present

# - name: Create nautobot user
#   ansible.builtin.user:
#     name: "{{ nautobot_user }}"
#     group: "{{ nautobot_group }}"
#     shell: /bin/bash
#     create_home: yes
#     home: "{{ nautobot_root }}"

# - name: Create Nautobot subdirectories with nautobot ownership
#   ansible.builtin.file:
#     path: "{{ item }}"
#     state: directory
#     owner: "{{ nautobot_user }}"
#     group: "{{ nautobot_group }}"
#     mode: "0755"
#   loop:
#     - "{{ nautobot_logs_path }}"
#     - "{{ nautobot_media_path }}"
#     - "{{ nautobot_static_path }}"
#     - "{{ nautobot_git_path }}"
#     - "{{ nautobot_git_root }}"

# - name: Ensure Nautobot log file exists and writable
#   ansible.builtin.file:
#     path: "{{ nautobot_logs_path }}/nautobot.log"
#     state: touch
#     owner: "{{ nautobot_user }}"
#     group: "{{ nautobot_group }}"
#     mode: "0644"

# - name: Create Python 3.11 virtual environment
#   ansible.builtin.command:
#     cmd: "{{ python_version }} -m venv {{ nautobot_venv }}"
#     creates: "{{ nautobot_venv }}/bin/python"
#   become: true

# - name: Upgrade pip in virtualenv
#   ansible.builtin.pip:
#     name: pip
#     state: latest
#     virtualenv: "{{ nautobot_venv }}"

# - name: Install wheel in virtualenv
#   ansible.builtin.pip:
#     name: wheel
#     state: present
#     virtualenv: "{{ nautobot_venv }}"

# - name: Install Nautobot core
#   ansible.builtin.pip:
#     name: "nautobot[postgres,redis]=={{ nautobot_version }}"
#     virtualenv: "{{ nautobot_venv }}"
#     extra_args: "{{ pip_extra_args | default('') }}"
#   tags: nautobot-core

# - name: Install gunicorn in virtualenv
#   ansible.builtin.pip:
#     name: gunicorn
#     state: present
#     virtualenv: "{{ nautobot_venv }}"

# - name: Install pip packages (dependencies)
#   ansible.builtin.pip:
#     name: "{{ item.name }}=={{ item.version }}"
#     virtualenv: "{{ nautobot_venv }}"
#     extra_args: "{{ pip_extra_args | default('') }}"
#   loop: "{{ nautobot_pip_packages | default([]) }}"
#   tags: pip-packages

# - name: Install Git-based packages (plugins)
#   ansible.builtin.pip:
#     name: "{{ item.name }}"
#     virtualenv: "{{ nautobot_venv }}"
#     extra_args: "{{ pip_extra_args | default('') }}"
#   loop: "{{ nautobot_git_packages | default([]) }}"
#   notify:
#     - Restart nautobot-app
#     - Restart nautobot-worker
#     - Restart nautobot-scheduler
#   tags: git-plugins

# - name: Deploy nautobot_config.py
#   ansible.builtin.template:
#     src: nautobot_config.py.j2
#     dest: "{{ nautobot_config_path }}"
#     owner: "{{ nautobot_user }}"
#     group: "{{ nautobot_group }}"
#     mode: "0640"
#   notify:
#     - Restart nautobot-app
#     - Restart nautobot-worker
#     - Restart nautobot-scheduler
#   tags: config

# - name: Run database migrations
#   ansible.builtin.command:
#     cmd: "{{ nautobot_venv }}/bin/nautobot-server migrate"
#   environment:
#     NAUTOBOT_CONFIG: "{{ nautobot_config_path }}"
#   register: migrate_result
#   changed_when: "'No migrations to apply' not in migrate_result.stdout"
#   tags: migrate

# - name: Collect static files
#   ansible.builtin.command:
#     cmd: "{{ nautobot_venv }}/bin/nautobot-server collectstatic --no-input"
#   environment:
#     NAUTOBOT_CONFIG: "{{ nautobot_config_path }}"
#   tags: static

# - name: Deploy nautobot-app systemd service
#   ansible.builtin.copy:
#     dest: "{{ systemd_path }}/nautobot-app.service"
#     mode: "0644"
#     content: |
#       [Unit]
#       Description=Nautobot WSGI Application
#       After=network-online.target
#       Wants=network-online.target

#       [Service]
#       Type=simple
#       User={{ nautobot_user }}
#       Group={{ nautobot_group }}
#       WorkingDirectory={{ nautobot_root }}
#       Environment="NAUTOBOT_CONFIG={{ nautobot_config_path }}"
#       ExecStart={{ nautobot_venv }}/bin/gunicorn --bind 0.0.0.0:8000 --workers 4 --timeout 300 nautobot.core.wsgi:application
#       Restart=on-failure
#       RestartSec=30s

#       [Install]
#       WantedBy=multi-user.target
#   notify: Reload systemd

# - name: Enable and start nautobot-app service
#   ansible.builtin.systemd:
#     name: nautobot-app
#     enabled: yes
#     state: started
#     daemon_reload: yes

---
- name: Install system packages
  ansible.builtin.apt:
    name:
      - python3.11
      - python3.11-venv
      - python3.11-dev
      - python3.11-distutils
      - nginx
      - build-essential
      - libpq-dev
      - libxml2-dev
      - libxslt1-dev
      - libffi-dev
      - libssl-dev
      - git
      - redis-tools
      - postgresql-client
    state: present
    update_cache: yes
  tags: packages

- name: Set variables
  ansible.builtin.set_fact:
    python_version: "/usr/bin/python3.11"
    nautobot_user: "{{ nautobot_user | default('nautobot') }}"
    nautobot_group: "{{ nautobot_group | default('nautobot') }}"
    nautobot_root: "{{ nautobot_root | default('/opt/nautobot') }}"
    nautobot_logs_path: "{{ nautobot_root }}/logs"
    nautobot_media_path: "{{ nautobot_root }}/media"
    nautobot_static_path: "{{ nautobot_root }}/static"
    nautobot_git_path: "{{ nautobot_root }}/git"
    nautobot_git_root: "{{ nautobot_root }}/.nautobot"
    nautobot_venv: "{{ nautobot_root }}/venv"
    nautobot_config_path: "{{ nautobot_root }}/nautobot_config.py"
    systemd_path: "/etc/systemd/system"

# ðŸ”¥ COMPLETE CLEANUP (automatic)
- name: Stop all services
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: stopped
  loop:
    - nautobot-gunicorn
    - nautobot-app
    - nginx
  ignore_errors: yes

- name: Remove old nautobot data
  ansible.builtin.file:
    path: "{{ nautobot_root }}"
    state: absent
  ignore_errors: yes

- name: Create nautobot group and user
  ansible.builtin.group:
    name: "{{ nautobot_group }}"
    state: present
  - name: Create nautobot user
  ansible.builtin.user:
    name: "{{ nautobot_user }}"
    group: "{{ nautobot_group }}"
    shell: /bin/bash
    create_home: no
    system: yes

- name: Create nautobot directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ nautobot_user }}"
    group: "{{ nautobot_group }}"
    mode: "0755"
  loop:
    - "{{ nautobot_root }}"
    - "{{ nautobot_logs_path }}"
    - "{{ nautobot_media_path }}"
    - "{{ nautobot_static_path }}"
    - "{{ nautobot_git_path }}"
    - "{{ nautobot_git_root }}"

- name: Create venv log file
  ansible.builtin.file:
    path: "{{ nautobot_logs_path }}/nautobot.log"
    state: touch
    owner: "{{ nautobot_user }}"
    group: "{{ nautobot_group }}"
    mode: "0664"

# ðŸ”¥ PYTHON ENVIRONMENT
- name: Create Python 3.11 venv
  ansible.builtin.command:
    cmd: "{{ python_version }} -m venv {{ nautobot_venv }}"
  become_user: "{{ nautobot_user }}"

- name: Upgrade pip
  ansible.builtin.pip:
    name: pip
    state: latest
    virtualenv: "{{ nautobot_venv }}"
  become_user: "{{ nautobot_user }}"

- name: Install Python packages
  ansible.builtin.pip:
    name: "{{ packages.name }}=={{ packages.version }}"
    virtualenv: "{{ nautobot_venv }}"
    extra_args: --no-cache-dir
  become_user: "{{ nautobot_user }}"
  loop:
    - { name: "wheel", version: "*" }
    - { name: "gunicorn", version: "22.0.0" }
  loop_control:
    loop_var: packages

- name: Install Nautobot core
  ansible.builtin.pip:
    name: "nautobot[postgres,redis]=={{ nautobot_version }}"
    virtualenv: "{{ nautobot_venv }}"
    extra_args: --no-cache-dir
  become_user: "{{ nautobot_user }}"
  tags: nautobot-core

- name: Install pip packages
  ansible.builtin.pip:
    name: "{{ item.name }}=={{ item.version }}"
    virtualenv: "{{ nautobot_venv }}"
    extra_args: --no-cache-dir
  become_user: "{{ nautobot_user }}"
  loop: "{{ nautobot_pip_packages | default([]) }}"
  tags: pip-packages

- name: Install git packages
  ansible.builtin.pip:
    name: "{{ item.name }}"
    virtualenv: "{{ nautobot_venv }}"
    extra_args: --no-cache-dir
  become_user: "{{ nautobot_user }}"
  loop: "{{ nautobot_git_packages | default([]) }}"
  tags: git-plugins

# ðŸ”¥ NAUTOBOT SETUP
- name: Deploy config
  ansible.builtin.template:
    src: nautobot_config.py.j2
    dest: "{{ nautobot_config_path }}"
    owner: "{{ nautobot_user }}"
    group: "{{ nautobot_group }}"
    mode: "0640"
  tags: config

- name: Run migrations
  ansible.builtin.command:
    cmd: "{{ nautobot_venv }}/bin/nautobot-server migrate"
  environment:
    NAUTOBOT_CONFIG: "{{ nautobot_config_path }}"
  become_user: "{{ nautobot_user }}"

- name: Collect static files
  ansible.builtin.command:
    cmd: "{{ nautobot_venv }}/bin/nautobot-server collectstatic --noinput"
  environment:
    NAUTOBOT_CONFIG: "{{ nautobot_config_path }}"
  become_user: "{{ nautobot_user }}"

- name: Fix static permissions
  ansible.builtin.file:
    path: "{{ nautobot_static_path }}"
    owner: "{{ nautobot_user }}"
    group: "{{ nautobot_group }}"
    recurse: yes
    mode: "0755"

# ðŸ”¥ NGINX CONFIG
- name: Remove default nginx
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: reload_nginx

- name: Deploy nginx config
  ansible.builtin.template:
    src: nginx-nautobot.conf.j2
    dest: /etc/nginx/sites-available/nautobot
  notify: reload_nginx

- name: Enable nginx site
  ansible.builtin.file:
    src: /etc/nginx/sites-available/nautobot
    dest: /etc/nginx/sites-enabled/nautobot
    state: link
  notify: reload_nginx

# ðŸ”¥ GUNICORN SERVICE
- name: Deploy gunicorn service
  ansible.builtin.copy:
    dest: "{{ systemd_path }}/nautobot-gunicorn.service"
    content: |
      [Unit]
      Description=Nautobot Gunicorn
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=notify
      User={{ nautobot_user }}
      Group={{ nautobot_group }}
      WorkingDirectory={{ nautobot_root }}
      Environment=NAUTOBOT_CONFIG={{ nautobot_config_path }}
      
      ExecStart={{ nautobot_venv }}/bin/gunicorn \
        --bind 127.0.0.1:8001 \
        --workers 3 \
        --worker-connections 1000 \
        --timeout 120 \
        --keep-alive 2 \
        nautobot.core.wsgi:application
      
      Restart=always
      RestartSec=5

      [Install]
      WantedBy=multi-user.target

# ðŸ”¥ START SERVICES
- name: Reload systemd
  ansible.builtin.systemd:
    daemon_reload: yes

- name: Start gunicorn
  ansible.builtin.systemd:
    name: nautobot-gunicorn
    state: started
    enabled: yes

- name: Wait gunicorn
  ansible.builtin.wait_for:
    host: 127.0.0.1
    port: 8001
    timeout: 30

- name: Start nginx
  ansible.builtin.systemd:
    name: nginx
    state: started
    enabled: yes

- name: Wait nginx
  ansible.builtin.wait_for:
    port: 80
    timeout: 30

- name: Health check
  ansible.builtin.uri:
    url: "http://127.0.0.1"
    status_code: 302
