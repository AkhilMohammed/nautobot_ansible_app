# # ---
# # - name: Ensure system packages are installed
# #   ansible.builtin.apt:
# #     name:
# #       - python3
# #       - python3-pip
# #       - python3-venv
# #       - python3-dev
# #       - build-essential
# #       - libpq-dev
# #       - libxml2-dev
# #       - libxslt1-dev
# #       - libffi-dev
# #       - libssl-dev
# #       - git
# #       - redis-tools
# #       - postgresql-client
# #     state: present
# #     update_cache: yes
# #   tags: packages

# # - name: Set default Python version for Nautobot venv
# #   ansible.builtin.set_fact:
# #     python_version: "{{ python_version | default('python3') }}"

# # - name: Ensure Nautobot defaults
# #   ansible.builtin.set_fact:
# #     nautobot_user: "{{ nautobot_user | default('nautobot') }}"
# #     nautobot_group: "{{ nautobot_group | default('nautobot') }}"
# #     nautobot_root: "{{ nautobot_root | default('/opt/nautobot') }}"
# #     nautobot_logs_path: "{{ nautobot_logs_path | default(nautobot_root + '/logs') }}"
# #     nautobot_media_path: "{{ nautobot_media_path | default(nautobot_root + '/media') }}"
# #     nautobot_static_path: "{{ nautobot_static_path | default(nautobot_root + '/static') }}"
# #     nautobot_git_path: "{{ nautobot_git_path | default(nautobot_root + '/git') }}"
# #     nautobot_git_root: "{{ nautobot_git_root | default(nautobot_root + '/.nautobot') }}"
# #     nautobot_venv: "{{ nautobot_venv | default(nautobot_root + '/venv') }}"

# # - name: Ensure Nautobot root directory exists (no ownership yet)
# #   ansible.builtin.file:
# #     path: "{{ nautobot_root }}"
# #     state: directory
# #     mode: "0755"

# # - name: Create nautobot group
# #   ansible.builtin.group:
# #     name: "{{ nautobot_group }}"
# #     state: present

# # - name: Create nautobot user
# #   ansible.builtin.user:
# #     name: "{{ nautobot_user }}"
# #     group: "{{ nautobot_group }}"
# #     shell: /bin/bash
# #     create_home: yes
# #     home: "{{ nautobot_root }}"

# # - name: Create Nautobot subdirectories with nautobot ownership
# #   ansible.builtin.file:
# #     path: "{{ item }}"
# #     state: directory
# #     owner: "{{ nautobot_user }}"
# #     group: "{{ nautobot_group }}"
# #     mode: "0755"
# #   loop:
# #     - "{{ nautobot_logs_path }}"
# #     - "{{ nautobot_media_path }}"
# #     - "{{ nautobot_static_path }}"
# #     - "{{ nautobot_git_path }}"
# #     - "{{ nautobot_git_root }}"

# # - name: Ensure Nautobot log file exists and writable
# #   ansible.builtin.file:
# #     path: "{{ nautobot_logs_path }}/nautobot.log"
# #     state: touch
# #     owner: "{{ nautobot_user }}"
# #     group: "{{ nautobot_group }}"
# #     mode: "0644"

# # - name: Create Python virtual environment
# #   ansible.builtin.command:
# #     cmd: "{{ python_version }} -m venv {{ nautobot_venv }}"
# #     creates: "{{ nautobot_venv }}/bin/python"
# #   become: true

# # - name: Upgrade pip in virtualenv
# #   ansible.builtin.pip:
# #     name: pip
# #     state: latest
# #     virtualenv: "{{ nautobot_venv }}"

# # - name: Install wheel in virtualenv
# #   ansible.builtin.pip:
# #     name: wheel
# #     state: present
# #     virtualenv: "{{ nautobot_venv }}"

# # - name: Install Nautobot core
# #   ansible.builtin.pip:
# #     name: "nautobot[postgres,redis]=={{ nautobot_version }}"
# #     virtualenv: "{{ nautobot_venv }}"
# #     extra_args: "{{ pip_extra_args | default('') }}"
# #   tags: nautobot-core

# # - name: Install gunicorn in virtualenv
# #   ansible.builtin.pip:
# #     name: gunicorn
# #     state: present
# #     virtualenv: "{{ nautobot_venv }}"

# # - name: Install pip packages (dependencies)
# #   ansible.builtin.pip:
# #     name: "{{ item.name }}=={{ item.version }}"
# #     virtualenv: "{{ nautobot_venv }}"
# #     extra_args: "{{ pip_extra_args | default('') }}"
# #   loop: "{{ nautobot_pip_packages | default([]) }}"
# #   tags: pip-packages

# # - name: Install Git-based packages (plugins)
# #   ansible.builtin.pip:
# #     name: "{{ item.name }}"
# #     virtualenv: "{{ nautobot_venv }}"
# #     extra_args: "{{ pip_extra_args | default('') }}"
# #   loop: "{{ nautobot_git_packages | default([]) }}"
# #   notify:
# #     - Restart nautobot-app
# #     - Restart nautobot-worker
# #     - Restart nautobot-scheduler
# #   tags: git-plugins

# # - name: Deploy nautobot_config.py
# #   ansible.builtin.template:
# #     src: nautobot_config.py.j2
# #     dest: "{{ nautobot_config_path }}"
# #     owner: "{{ nautobot_user }}"
# #     group: "{{ nautobot_group }}"
# #     mode: "0640"
# #   notify:
# #     - Restart nautobot-app
# #     - Restart nautobot-worker
# #     - Restart nautobot-scheduler
# #   tags: config

# # - name: Run database migrations
# #   ansible.builtin.command:
# #     cmd: "{{ nautobot_venv }}/bin/nautobot-server migrate"
# #   environment:
# #     NAUTOBOT_CONFIG: "{{ nautobot_config_path }}"
# #   register: migrate_result
# #   changed_when: "'No migrations to apply' not in migrate_result.stdout"
# #   tags: migrate

# # - name: Collect static files
# #   ansible.builtin.command:
# #     cmd: "{{ nautobot_venv }}/bin/nautobot-server collectstatic --no-input"
# #   environment:
# #     NAUTOBOT_CONFIG: "{{ nautobot_config_path }}"
# #   tags: static

# # - name: Deploy nautobot-app systemd service
# #   ansible.builtin.copy:
# #     dest: "{{ systemd_path }}/nautobot-app.service"
# #     mode: "0644"
# #     content: |
# #       [Unit]
# #       Description=Nautobot WSGI Application
# #       After=network-online.target
# #       Wants=network-online.target

# #       [Service]
# #       Type=simple
# #       User={{ nautobot_user }}
# #       Group={{ nautobot_group }}
# #       WorkingDirectory={{ nautobot_root }}
# #       Environment="NAUTOBOT_CONFIG={{ nautobot_config_path }}"
# #       ExecStart={{ nautobot_venv }}/bin/gunicorn --bind 0.0.0.0:8000 --workers 4 --timeout 300 nautobot.core.wsgi:application
# #       Restart=on-failure
# #       RestartSec=30s

# #       [Install]
# #       WantedBy=multi-user.target
# #   notify: Reload systemd

# # - name: Enable and start nautobot-app service
# #   ansible.builtin.systemd:
# #     name: nautobot-app
# #     enabled: yes
# #     state: started
# #     daemon_reload: yes


# ---
# - name: Ensure system packages are installed
#   ansible.builtin.apt:
#     name:
#       - python3.11
#       - python3.11-venv
#       - python3.11-dev
#       - python3.11-distutils
#       - build-essential
#       - libpq-dev
#       - libxml2-dev
#       - libxslt1-dev
#       - libffi-dev
#       - libssl-dev
#       - git
#       - redis-tools
#       - postgresql-client
#     state: present
#     update_cache: yes
#   tags: packages

# - name: Set Python version for Nautobot
#   ansible.builtin.set_fact:
#     python_version: python3.11

# - name: Ensure Nautobot defaults
#   ansible.builtin.set_fact:
#     nautobot_user: "{{ nautobot_user | default('nautobot') }}"
#     nautobot_group: "{{ nautobot_group | default('nautobot') }}"
#     nautobot_root: "{{ nautobot_root | default('/opt/nautobot') }}"
#     nautobot_logs_path: "{{ nautobot_logs_path | default(nautobot_root + '/logs') }}"
#     nautobot_media_path: "{{ nautobot_media_path | default(nautobot_root + '/media') }}"
#     nautobot_static_path: "{{ nautobot_static_path | default(nautobot_root + '/static') }}"
#     nautobot_git_path: "{{ nautobot_git_path | default(nautobot_root + '/git') }}"
#     nautobot_git_root: "{{ nautobot_git_root | default(nautobot_root + '/.nautobot') }}"
#     nautobot_venv: "{{ nautobot_venv | default(nautobot_root + '/venv') }}"

# - name: Ensure Nautobot root directory exists (no ownership yet)
#   ansible.builtin.file:
#     path: "{{ nautobot_root }}"
#     state: directory
#     mode: "0755"

# - name: Create nautobot group
#   ansible.builtin.group:
#     name: "{{ nautobot_group }}"
#     state: present

# - name: Create nautobot user
#   ansible.builtin.user:
#     name: "{{ nautobot_user }}"
#     group: "{{ nautobot_group }}"
#     shell: /bin/bash
#     create_home: yes
#     home: "{{ nautobot_root }}"

# - name: Create Nautobot subdirectories with nautobot ownership
#   ansible.builtin.file:
#     path: "{{ item }}"
#     state: directory
#     owner: "{{ nautobot_user }}"
#     group: "{{ nautobot_group }}"
#     mode: "0755"
#   loop:
#     - "{{ nautobot_logs_path }}"
#     - "{{ nautobot_media_path }}"
#     - "{{ nautobot_static_path }}"
#     - "{{ nautobot_git_path }}"
#     - "{{ nautobot_git_root }}"

# - name: Ensure Nautobot log file exists and writable
#   ansible.builtin.file:
#     path: "{{ nautobot_logs_path }}/nautobot.log"
#     state: touch
#     owner: "{{ nautobot_user }}"
#     group: "{{ nautobot_group }}"
#     mode: "0644"

# - name: Create Python 3.11 virtual environment
#   ansible.builtin.command:
#     cmd: "{{ python_version }} -m venv {{ nautobot_venv }}"
#     creates: "{{ nautobot_venv }}/bin/python"
#   become: true

# - name: Upgrade pip in virtualenv
#   ansible.builtin.pip:
#     name: pip
#     state: latest
#     virtualenv: "{{ nautobot_venv }}"

# - name: Install wheel in virtualenv
#   ansible.builtin.pip:
#     name: wheel
#     state: present
#     virtualenv: "{{ nautobot_venv }}"

# - name: Install Nautobot core
#   ansible.builtin.pip:
#     name: "nautobot[postgres,redis]=={{ nautobot_version }}"
#     virtualenv: "{{ nautobot_venv }}"
#     extra_args: "{{ pip_extra_args | default('') }}"
#   tags: nautobot-core

# - name: Install gunicorn in virtualenv
#   ansible.builtin.pip:
#     name: gunicorn
#     state: present
#     virtualenv: "{{ nautobot_venv }}"

# - name: Install pip packages (dependencies)
#   ansible.builtin.pip:
#     name: "{{ item.name }}=={{ item.version }}"
#     virtualenv: "{{ nautobot_venv }}"
#     extra_args: "{{ pip_extra_args | default('') }}"
#   loop: "{{ nautobot_pip_packages | default([]) }}"
#   tags: pip-packages

# - name: Install Git-based packages (plugins)
#   ansible.builtin.pip:
#     name: "{{ item.name }}"
#     virtualenv: "{{ nautobot_venv }}"
#     extra_args: "{{ pip_extra_args | default('') }}"
#   loop: "{{ nautobot_git_packages | default([]) }}"
#   notify:
#     - Restart nautobot-app
#     - Restart nautobot-worker
#     - Restart nautobot-scheduler
#   tags: git-plugins

# - name: Deploy nautobot_config.py
#   ansible.builtin.template:
#     src: nautobot_config.py.j2
#     dest: "{{ nautobot_config_path }}"
#     owner: "{{ nautobot_user }}"
#     group: "{{ nautobot_group }}"
#     mode: "0640"
#   notify:
#     - Restart nautobot-app
#     - Restart nautobot-worker
#     - Restart nautobot-scheduler
#   tags: config

# - name: Run database migrations
#   ansible.builtin.command:
#     cmd: "{{ nautobot_venv }}/bin/nautobot-server migrate"
#   environment:
#     NAUTOBOT_CONFIG: "{{ nautobot_config_path }}"
#   register: migrate_result
#   changed_when: "'No migrations to apply' not in migrate_result.stdout"
#   tags: migrate

# - name: Collect static files
#   ansible.builtin.command:
#     cmd: "{{ nautobot_venv }}/bin/nautobot-server collectstatic --no-input"
#   environment:
#     NAUTOBOT_CONFIG: "{{ nautobot_config_path }}"
#   tags: static

# - name: Deploy nautobot-app systemd service
#   ansible.builtin.copy:
#     dest: "{{ systemd_path }}/nautobot-app.service"
#     mode: "0644"
#     content: |
#       [Unit]
#       Description=Nautobot WSGI Application
#       After=network-online.target
#       Wants=network-online.target

#       [Service]
#       Type=simple
#       User={{ nautobot_user }}
#       Group={{ nautobot_group }}
#       WorkingDirectory={{ nautobot_root }}
#       Environment="NAUTOBOT_CONFIG={{ nautobot_config_path }}"
#       ExecStart={{ nautobot_venv }}/bin/gunicorn --bind 0.0.0.0:8000 --workers 4 --timeout 300 nautobot.core.wsgi:application
#       Restart=on-failure
#       RestartSec=30s

#       [Install]
#       WantedBy=multi-user.target
#   notify: Reload systemd

# - name: Enable and start nautobot-app service
#   ansible.builtin.systemd:
#     name: nautobot-app
#     enabled: yes
#     state: started
#     daemon_reload: yes


---
- name: Ensure system packages are installed
  ansible.builtin.apt:
    name:
      - python3.11
      - python3.11-venv
      - python3.11-dev
      - python3.11-distutils
      - nginx
      - build-essential
      - libpq-dev
      - libxml2-dev
      - libxslt1-dev
      - libffi-dev
      - libssl-dev
      - git
      - redis-tools
      - postgresql-client
    state: present
    update_cache: yes
  tags: packages

- name: Set Python version for Nautobot
  ansible.builtin.set_fact:
    python_version: "/usr/bin/python3.11"

- name: Ensure Nautobot defaults
  ansible.builtin.set_fact:
    nautobot_user: "{{ nautobot_user | default('nautobot') }}"
    nautobot_group: "{{ nautobot_group | default('nautobot') }}"
    nautobot_root: "{{ nautobot_root | default('/opt/nautobot') }}"
    nautobot_logs_path: "{{ nautobot_logs_path | default(nautobot_root + '/logs') }}"
    nautobot_media_path: "{{ nautobot_media_path | default(nautobot_root + '/media') }}"
    nautobot_static_path: "{{ nautobot_static_path | default(nautobot_root + '/static') }}"
    nautobot_git_path: "{{ nautobot_git_path | default(nautobot_root + '/git') }}"
    nautobot_git_root: "{{ nautobot_git_root | default(nautobot_root + '/.nautobot') }}"
    nautobot_venv: "{{ nautobot_venv | default(nautobot_root + '/venv') }}"
    nautobot_config_path: "{{ nautobot_config_path | default(nautobot_root + '/nautobot_config.py') }}"
    systemd_path: "{{ systemd_path | default('/etc/systemd/system') }}"

# üî• AUTOMATIC FULL CLEANUP - NO MANUAL STEPS
- name: Stop all Nautobot and nginx services
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: stopped
    enabled: no
  loop:
    - nautobot-gunicorn
    - nautobot-app
    - nautobot-worker
    - nautobot-scheduler
    - nginx
  ignore_errors: yes

- name: Force remove ALL Nautobot data (clean slate)
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ nautobot_root }}"
    - "{{ systemd_path }}/nautobot*"
  ignore_errors: yes

- name: Create nautobot group
  ansible.builtin.group:
    name: "{{ nautobot_group }}"
    state: present

- name: Create nautobot user (no home dir yet)
  ansible.builtin.user:
    name: "{{ nautobot_user }}"
    group: "{{ nautobot_group }}"
    shell: /bin/bash
    create_home: no
    system: yes

- name: Create Nautobot root directory (root owned, ansible writable)
  ansible.builtin.file:
    path: "{{ nautobot_root }}"
    state: directory
    owner: root
    group: "{{ nautobot_group }}"
    mode: "0775"

# üóëÔ∏è AUTOMATICALLY remove ansible tmp issues
- name: Remove any existing .ansible tmp directories
  ansible.builtin.file:
    path: "{{ nautobot_root }}/.ansible"
    state: absent
  ignore_errors: yes

- name: Create Nautobot subdirectories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ nautobot_user }}"
    group: "{{ nautobot_group }}"
    mode: "0775"
  loop:
    - "{{ nautobot_logs_path }}"
    - "{{ nautobot_media_path }}"
    - "{{ nautobot_static_path }}"
    - "{{ nautobot_git_path }}"
    - "{{ nautobot_git_root }}"

- name: Ensure Nautobot log file exists
  ansible.builtin.file:
    path: "{{ nautobot_logs_path }}/nautobot.log"
    state: touch
    owner: "{{ nautobot_user }}"
    group: "{{ nautobot_group }}"
    mode: "0664"

# ‚úÖ PERFECT VENV CREATION (automatic permissions)
- name: Create Python 3.11 virtual environment
  ansible.builtin.command:
    cmd: "{{ python_version }} -m venv {{ nautobot_venv }}"
  environment:
    HOME: "/tmp"

- name: Fix venv ownership and permissions
  ansible.builtin.file:
    path: "{{ nautobot_venv }}"
    owner: "{{ nautobot_user }}"
    group: "{{ nautobot_group }}"
    recurse: yes
    mode: "0755"

- name: Verify Python version
  ansible.builtin.command:
    cmd: "{{ nautobot_venv }}/bin/python --version"
  register: python_version_check
  become_user: "{{ nautobot_user }}"
  changed_when: false

- name: Debug Python version
  ansible.builtin.debug:
    msg: "‚úÖ Venv Python: {{ python_version_check.stdout }}"

- name: Upgrade pip
  ansible.builtin.pip:
    name: pip==24.0
    virtualenv: "{{ nautobot_venv }}"
    extra_args: --upgrade
  become_user: "{{ nautobot_user }}"

- name: Install wheel
  ansible.builtin.pip:
    name: wheel
    virtualenv: "{{ nautobot_venv }}"
  become_user: "{{ nautobot_user }}"

- name: Install Nautobot core
  ansible.builtin.pip:
    name: "nautobot[postgres,redis]=={{ nautobot_version }}"
    virtualenv: "{{ nautobot_venv }}"
    extra_args: "--no-cache-dir"
  become_user: "{{ nautobot_user }}"
  tags: nautobot-core

- name: Install gunicorn
  ansible.builtin.pip:
    name: gunicorn==22.0.0
    virtualenv: "{{ nautobot_venv }}"
  become_user: "{{ nautobot_user }}"

- name: Install pip packages
  ansible.builtin.pip:
    name: "{{ item.name }}=={{ item.version }}"
    virtualenv: "{{ nautobot_venv }}"
    extra_args: "--no-cache-dir"
  become_user: "{{ nautobot_user }}"
  loop: "{{ nautobot_pip_packages | default([]) }}"
  tags: pip-packages


# [Previous tasks unchanged until pip installs...]

- name: Install gevent for gunicorn workers
  ansible.builtin.pip:
    name: gevent==24.1.0
    virtualenv: "{{ nautobot_venv }}"
  become_user: "{{ nautobot_user }}"

- name: Install Git-based packages
  ansible.builtin.pip:
    name: "{{ item.name }}"
    virtualenv: "{{ nautobot_venv }}"
    extra_args: "--no-cache-dir"
  become_user: "{{ nautobot_user }}"
  loop: "{{ nautobot_git_packages | default([]) }}"
  tags: git-plugins

- name: Deploy nautobot_config.py
  ansible.builtin.template:
    src: nautobot_config.py.j2
    dest: "{{ nautobot_config_path }}"
    owner: "{{ nautobot_user }}"
    group: "{{ nautobot_group }}"
    mode: "0640"
  tags: config

# üî• WAIT FOR DATABASE READY
- name: Wait for PostgreSQL
  ansible.builtin.wait_for:
    host: "{{ postgres_host | default('localhost') }}"
    port: "{{ postgres_port | default(5432) }}"
    state: started
    timeout: 30

- name: Run database migrations
  ansible.builtin.command:
    cmd: "{{ nautobot_venv }}/bin/nautobot-server migrate"
  environment:
    NAUTOBOT_CONFIG: "{{ nautobot_config_path }}"
  become_user: "{{ nautobot_user }}"
  register: migrate_result
  changed_when: "'No migrations to apply' not in migrate_result.stdout"
  tags: migrate

- name: Create superuser if not exists
  ansible.builtin.command:
    cmd: "{{ nautobot_venv }}/bin/nautobot-server createsuperuser --noinput --username admin --email admin@example.com"
  environment:
    NAUTOBOT_CONFIG: "{{ nautobot_config_path }}"
  become_user: "{{ nautobot_user }}"
  register: createsuperuser
  failed_when: "'already exists' not in createsuperuser.stderr"
  ignore_errors: yes

- name: Collect static files
  ansible.builtin.command:
    cmd: "{{ nautobot_venv }}/bin/nautobot-server collectstatic --no-input"
  environment:
    NAUTOBOT_CONFIG: "{{ nautobot_config_path }}"
  become_user: "{{ nautobot_user }}"

- name: Fix static files permissions
  ansible.builtin.file:
    path: "{{ nautobot_static_path }}"
    owner: "{{ nautobot_user }}"
    group: "{{ nautobot_group }}"
    recurse: yes
    mode: "0755"

# üî• SIMPLIFIED GUNICORN SERVICE (NO gevent - bulletproof)
- name: Deploy nautobot-gunicorn systemd service
  ansible.builtin.copy:
    dest: "{{ systemd_path }}/nautobot-gunicorn.service"
    mode: 0644
    content: |
      [Unit]
      Description=Nautobot Gunicorn (Production)
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=notify
      User={{ nautobot_user }}
      Group={{ nautobot_group }}
      WorkingDirectory={{ nautobot_root }}
      Environment="NAUTOBOT_CONFIG={{ nautobot_config_path }}"
      Environment="PYTHONPATH={{ nautobot_root }}"
      
      ExecStart={{ nautobot_venv }}/bin/gunicorn \
        --name nautobot \
        --workers 3 \
        --worker-tmp-dir /dev/shm \
        --bind=127.0.0.1:8001 \
        --timeout=120 \
        --max-requests=1000 \
        --max-requests-jitter=100 \
        --keep-alive=2 \
        nautobot.core.wsgi:application
      
      ExecReload=/bin/kill -s HUP $MAINPID
      Restart=on-failure
      RestartSec=5s
      TimeoutStopSec=300
      PrivateTmp=true

      [Install]
      WantedBy=multi-user.target

# üî• NGINX CONFIG (unchanged)
- name: Remove default nginx site
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: reload_nginx

- name: Deploy nginx Nautobot config
  ansible.builtin.template:
    src: nginx-nautobot.conf.j2
    dest: /etc/nginx/sites-available/nautobot
    mode: 0644
  notify: reload_nginx

- name: Enable Nautobot nginx site
  ansible.builtin.file:
    src: /etc/nginx/sites-available/nautobot
    dest: /etc/nginx/sites-enabled/nautobot
    state: link
  notify: reload_nginx

# üî• START SERVICES WITH HEALTH CHECKS
- name: Reload systemd
  ansible.builtin.systemd:
    daemon_reload: yes

- name: Start nautobot-gunicorn
  ansible.builtin.systemd:
    name: nautobot-gunicorn
    state: started
    enabled: yes

- name: Wait for gunicorn to be ready
  ansible.builtin.wait_for:
    host: 127.0.0.1
    port: 8001
    delay: 5
    timeout: 30

- name: Start nginx
  ansible.builtin.systemd:
    name: nginx
    state: started
    enabled: yes

- name: Wait for nginx to be ready
  ansible.builtin.wait_for:
    host: 0.0.0.0
    port: 80
    delay: 5
    timeout: 30
