"""
Nautobot configuration file
Generated by Ansible - DO NOT EDIT MANUALLY
Environment: {{ nautobot_environment }}
"""

import os
from nautobot.core.settings import *  # noqa: F401,F403
from nautobot.core.settings_funcs import is_truthy, parse_redis_connection

# ===========================
# Core Settings
# ===========================

ALLOWED_HOSTS = {{ nautobot_allowed_hosts | to_nice_json }}
DEBUG = {{ nautobot_debug | default(false) | ternary('True', 'False') }}
SECRET_KEY = "{{ nautobot_secret_key }}"

# Add to your existing config file:
SECURE_SSL_REDIRECT = True
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
ALLOWED_HOSTS = ['*', '172.17.228.202']
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True


# ===========================
# Database Configuration
# ===========================

DATABASES = {
    "default": {
        "ENGINE": "{{ nautobot_db.engine }}",
        "NAME": "{{ nautobot_db.name }}",
        "USER": "{{ nautobot_db.user }}",
        "PASSWORD": "{{ nautobot_db.password }}",
        "HOST": "{{ nautobot_db.host }}",
        "PORT": {{ nautobot_db.port }},
        "CONN_MAX_AGE": {{ nautobot_db.conn_max_age }},
{% if nautobot_db.options is defined %}
        "OPTIONS": {{ nautobot_db.options | to_nice_json }},
{% endif %}
    }
}

# ===========================
# Redis Configuration
# ===========================

{% set redis_pw = nautobot_redis.password | default('', true) %}

CACHES = {
    "default": {
        "BACKEND": "django_redis.cache.RedisCache",
        "LOCATION": "redis://{% if redis_pw %}:{{ redis_pw }}@{% endif %}{{ nautobot_redis.host }}:{{ nautobot_redis.port }}/{{ nautobot_redis.database | default(0) }}",
        "OPTIONS": {
            "CLIENT_CLASS": "django_redis.client.DefaultClient",
        },
    }
}

# ===========================
# Celery Configuration
# ===========================

CELERY_BROKER_URL = "redis://{% if redis_pw %}:{{ redis_pw }}@{% endif %}{{ nautobot_redis.host }}:{{ nautobot_redis.port }}/{{ nautobot_redis.database | default(0) }}"
CELERY_RESULT_BACKEND = "redis://{% if redis_pw %}:{{ redis_pw }}@{% endif %}{{ nautobot_redis.host }}:{{ nautobot_redis.port }}/1"

# ===========================
# Plugin Configuration
# ===========================

PLUGINS = [
{% for plugin in nautobot_git_packages %}
    "{{ plugin.module_name }}",
{% endfor %}
]

PLUGINS_CONFIG = {
{% for plugin_name, config in nautobot_plugins_config.items() %}
    "{{ plugin_name }}": {{ config | to_nice_json | replace('true', 'True') | replace('false', 'False') }},
{% endfor %}
}
# ===========================
# Logging Configuration
# ===========================

LOGGING = {
    "version": 1,
    "disable_existing_loggers": False,
    "formatters": {
        "normal": {
            "format": "%(asctime)s [%(levelname)s] %(name)s: %(message)s"
        },
        "verbose": {
            "format": "%(asctime)s [%(levelname)s] %(name)s (%(module)s:%(lineno)d): %(message)s"
        },
    },
    "handlers": {
        "file": {
            "level": "{{ nautobot_log_level }}",
            "class": "logging.handlers.RotatingFileHandler",
            "filename": "{{ nautobot_logs_path }}/nautobot.log",
            "maxBytes": 10485760,  # 10MB
            "backupCount": 5,
            "formatter": "verbose",
        },
        "console": {
            "level": "{{ nautobot_log_level }}",
            "class": "logging.StreamHandler",
            "formatter": "normal",
        },
    },
    "root": {
        "handlers": ["console", "file"],
        "level": "{{ nautobot_log_level }}",
    },
}



# ===========================
# Storage Configuration
# ===========================

MEDIA_ROOT = "{{ nautobot_media_path }}"
STATIC_ROOT = "{{ nautobot_static_path }}"

# ===========================
# Security Settings
# ===========================

{% if not nautobot_debug %}
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True
{% endif %}
